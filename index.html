<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>ตารางเรียน ม.5/1</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap");
            * {
                font-family: "Prompt", system-ui, -apple-system, sans-serif;
            }
            .mono {
                font-variant-numeric: tabular-nums;
            }
            * {
                transition: background-color 0.2s ease, border-color 0.2s ease;
            }
            .tab-btn[aria-current="true"] {
                background-color: rgb(59 130 246 / 0.1);
                border-color: rgb(147 197 253);
            }
            .tab-btn[aria-current="true"] .tab-label {
                color: rgb(37 99 235);
            }
        </style>
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/favicon_io/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon_io/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon_io/favicon-16x16.png"
        />
        <meta name="theme-color" content="#0ea5e9" />
        <link rel="manifest" href="/favicon_io/site.webmanifest" />
        <link rel="manifest" href="/site.webmanifest" />
    </head>
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("/sw.js")
                    .catch((err) => console.error("SW register failed:", err));
            });
        }
    </script>

    <body
        class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 min-h-screen"
    >
        <div class="max-w-5xl mx-auto p-4 md:p-8">
            <!-- Header -->
            <header class="mb-6">
                <h1
                    class="text-3xl md:text-4xl font-semibold text-gray-900 dark:text-white mb-2"
                >
                    ตารางเรียน ม.5/1
                </h1>
                <p class="text-gray-500 dark:text-gray-400 text-sm">
                    ภาคเรียนที่ 2 โรงเรียนภูเขียว
                </p>
            </header>

            <!-- Current Time Card -->
            <div
                class="mb-4 p-6 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800"
            >
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <div
                            class="text-sm text-gray-500 dark:text-gray-400 mb-1"
                        >
                            วันนี้
                        </div>
                        <div
                            id="nowDate"
                            class="text-lg font-medium text-gray-900 dark:text-white"
                        >
                            —
                        </div>
                    </div>
                    <div class="md:text-right">
                        <div
                            class="text-sm text-gray-500 dark:text-gray-400 mb-1"
                        >
                            เวลา
                        </div>
                        <div
                            id="nowTime"
                            class="text-2xl font-semibold mono text-gray-900 dark:text-white"
                        >
                            --:--:--
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Period - Large Card -->
            <div class="mb-6" id="currentBlock">
                <div
                    id="currentCard"
                    class="p-8 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-2xl shadow-lg text-white"
                >
                    <div class="text-sm opacity-90 mb-2">กำลังเรียน</div>
                    <div
                        id="currentSubject"
                        class="text-3xl font-semibold mb-2"
                    >
                        —
                    </div>
                    <div id="currentTeacher" class="text-lg opacity-90 mb-3">
                        —
                    </div>
                    <div
                        class="flex items-center justify-between flex-wrap gap-4"
                    >
                        <div id="currentTime" class="mono text-lg opacity-90">
                            —
                        </div>
                        <div
                            id="currentStatus"
                            class="text-sm bg-white/20 px-4 py-2 rounded-full"
                        >
                            —
                        </div>
                    </div>
                </div>
            </div>

            <!-- Previous & Next Period -->
            <div class="grid md:grid-cols-2 gap-4 mb-8" id="adjacentBlock">
                <!-- Previous -->
                <div
                    class="p-6 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800"
                >
                    <div
                        class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3"
                    >
                        คาบที่แล้ว
                    </div>
                    <div
                        id="prevSubject"
                        class="text-xl font-medium text-gray-900 dark:text-white mb-1"
                    >
                        —
                    </div>
                    <div
                        id="prevTeacher"
                        class="text-sm text-gray-600 dark:text-gray-400 mb-2"
                    >
                        —
                    </div>
                    <div
                        id="prevTime"
                        class="mono text-sm text-gray-500 dark:text-gray-500 mb-2"
                    >
                        —
                    </div>
                    <div
                        id="prevEnded"
                        class="text-xs text-gray-400 dark:text-gray-600"
                    >
                        —
                    </div>
                </div>

                <!-- Next -->
                <div
                    class="p-6 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800"
                >
                    <div
                        class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-3"
                    >
                        คาบถัดไป
                    </div>
                    <div
                        id="nextSubject"
                        class="text-xl font-medium text-gray-900 dark:text-white mb-1"
                    >
                        —
                    </div>
                    <div
                        id="nextTeacher"
                        class="text-sm text-gray-600 dark:text-gray-400 mb-2"
                    >
                        —
                    </div>
                    <div
                        id="nextTime"
                        class="mono text-sm text-gray-500 dark:text-gray-500 mb-2"
                    >
                        —
                    </div>
                    <div
                        id="nextCountdown"
                        class="text-xs text-gray-400 dark:text-gray-600"
                    >
                        —
                    </div>
                </div>
            </div>

            <section>
                <!-- Weekday Tabs -->
                <div class="mb-6">
                    <div class="flex justify-between">
                        <button
                            id="prevDayBtn"
                            class="px-3 py-2 rounded-xl border"
                        >
                            ก่อนหน้า
                        </button>
                        <div
                            id="weekdayTabs"
                            class="flex flex-wrap gap-2"
                        ></div>
                        <button
                            id="nextDayBtn"
                            class="px-3 py-2 rounded-xl border"
                        >
                            ถัดไป
                        </button>
                    </div>
                </div>
                <h2
                    id="todayTitle"
                    class="text-xl font-semibold text-gray-900 dark:text-white mb-4"
                >
                    ตารางวันนี้
                </h2>
                <!-- Search Bar -->
                <div class="mb-4 flex items-center gap-3">
                    <div class="relative flex-1">
                        <input
                            id="searchInput"
                            type="text"
                            inputmode="search"
                            placeholder="ค้นหาวิชา หรือชื่อครู"
                            class="w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2.5 outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <kbd
                            class="hidden md:block absolute right-3 top-2.5 text-xs px-1.5 py-0.5 rounded border border-gray-300 dark:border-gray-700 text-gray-500 dark:text-gray-400"
                            >/</kbd
                        >
                    </div>
                    <button
                        id="clearSearchBtn"
                        class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800"
                    >
                        ล้าง
                    </button>
                </div>
                <div id="searchResults" class="space-y-2 mb-6 hidden"></div>
                <div id="todayTable" class="space-y-2"></div>
            </section>
        </div>

        <script>
            let SCHEDULE = {};
            let selectedWd = new Date().getDay(); // 0=อา ... 6=ส
            const WEEKDAY_THAI = [
                "อาทิตย์",
                "จันทร์",
                "อังคาร",
                "พุธ",
                "พฤหัสบดี",
                "ศุกร์",
                "เสาร์",
            ];

            async function loadSchedule() {
                try {
                    const res = await fetch("./schedule.json");
                    SCHEDULE = await res.json();
                    initSchedule();
                } catch (error) {
                    console.error("ไม่สามารถโหลดไฟล์ schedule.json:", error);
                    el(
                        "todayTable"
                    ).innerHTML = `<div class="p-6 text-center text-red-500 dark:text-red-400 bg-white dark:bg-gray-900 rounded-2xl border border-dashed border-red-300 dark:border-red-800">ไม่สามารถโหลดตารางเรียนได้</div>`;
                }
            }

            const pad = (n) => String(n).padStart(2, "0");
            const parseHM = (hm, base = new Date()) => {
                const [H, M] = hm.split(":").map(Number);
                const d = new Date(base);
                d.setHours(H, M, 0, 0);
                return d;
            };
            const fmtHM = (d) => pad(d.getHours()) + ":" + pad(d.getMinutes());
            // ---------- Search helpers ----------
            let searchTerm = ""; // สถานะคำค้น

            const escapeHTML = (s) =>
                s == null
                    ? ""
                    : String(s)
                          .replace(/&/g, "&amp;")
                          .replace(/</g, "&lt;")
                          .replace(/>/g, "&gt;")
                          .replace(/"/g, "&quot;")
                          .replace(/'/g, "&#39;");

            // สร้าง RegExp จากคำค้น (หนีอักขระพิเศษ)
            const makeQueryRegex = (q) => {
                if (!q) return null;
                const escaped = q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                try {
                    return new RegExp(escaped, "gi"); // case-insensitive สำหรับภาษาอังกฤษ; ภาษาไทยไม่กระทบ
                } catch {
                    return null;
                }
            };

            // ไฮไลต์คำที่ตรงใน text (คืนค่าเป็น HTML ที่ escape แล้ว+mark)
            const highlightHTML = (text, q) => {
                if (!q) return escapeHTML(text || "");
                const rx = makeQueryRegex(q);
                if (!rx) return escapeHTML(text || "");
                const raw = String(text || "");
                // ตัดเป็นส่วน ๆ แล้วประกบด้วย <mark>
                let out = "";
                let last = 0;
                for (const m of raw.matchAll(rx)) {
                    const i = m.index ?? 0;
                    out += escapeHTML(raw.slice(last, i));
                    out += `<mark class="px-1 rounded bg-yellow-200 text-gray-900 dark:bg-yellow-500/70 dark:text-gray-900">${escapeHTML(
                        m[0]
                    )}</mark>`;
                    last = i + m[0].length;
                }
                out += escapeHTML(raw.slice(last));
                return out;
            };

            // ช่วยดูว่าการ์ดนี้ "ตรงคำค้น" ไหม (เช็คทั้งวิชาและครู)
            const isMatch = (p, q) => {
                if (!q) return true;
                const t = q.toLowerCase();
                return (
                    (p.subject || "").toLowerCase().includes(t) ||
                    (p.teacher || "").toLowerCase().includes(t)
                );
            };

            // debounce เล็กน้อยเวลา keyup
            const debounce = (fn, ms = 120) => {
                let h;
                return (...args) => {
                    clearTimeout(h);
                    h = setTimeout(() => fn(...args), ms);
                };
            };

            const humanizeMs = (ms) => {
                if (ms <= 0) return "ถึงเวลาแล้ว";
                const totalSec = Math.floor(ms / 1000);
                const h = Math.floor(totalSec / 3600);
                const m = Math.floor((totalSec % 3600) / 60);
                const s = totalSec % 60;
                if (h > 0) return `${h} ชม. ${m} นาที`;
                if (m > 0) return `${m} นาที ${s} วินาที`;
                return `${s} วินาที`;
            };
            function renderSearchResults(q) {
                const box = document.getElementById("searchResults");
                // ถ้าไม่มีคำค้น: ซ่อนพาเนลแล้วออก
                if (!q || !q.trim()) {
                    box.classList.add("hidden");
                    box.innerHTML = "";
                    return;
                }

                const results = [];
                // ค้นหาเฉพาะวันจันทร์–ศุกร์ (1..5) ตามโค้ดเดิมของแท็บ
                for (let wd = 1; wd <= 5; wd++) {
                    const dayPeriods = getScheduleByWd(wd) || [];
                    // ไม่จำเป็นต้อง enrich เวลา เพราะเราจะแสดงตามสตริง start/end ก็พอ
                    for (const p of dayPeriods) {
                        if (isMatch(p, q)) {
                            results.push({ wd, p });
                        }
                    }
                }

                // เรนเดอร์
                if (!results.length) {
                    box.classList.remove("hidden");
                    box.innerHTML = `
      <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 text-gray-500 dark:text-gray-400">
        ไม่พบผลลัพธ์ที่ตรงในสัปดาห์นี้
      </div>`;
                    return;
                }

                // สรุปหัวข้อ
                const header = `
    <div class="p-3 rounded-xl bg-gray-100/60 dark:bg-gray-800/60 border border-gray-200 dark:border-gray-800 text-sm text-gray-600 dark:text-gray-300">
      ผลการค้นหา (ทุกวัน): <span class="font-medium">${results.length}</span> รายการ
    </div>
  `;

                const itemsHTML = results
                    .map(({ wd, p }) => {
                        const dayBadge = `
      <span class="text-xs px-2 py-1 rounded-full border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-950 text-blue-700 dark:text-blue-300">
        วัน${WEEKDAY_THAI[wd]}
      </span>
    `;

                        const subjectHTML = highlightHTML(p.subject, q);
                        const teacherText = p.teacher ? `ครู${p.teacher}` : "";
                        const teacherHTML = highlightHTML(teacherText, q);
                        const roomHTML = p.room
                            ? ` • ห้อง ${escapeHTML(p.room)}`
                            : "";

                        return `
      <div class="p-4 rounded-xl border bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800 flex items-center justify-between">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            ${dayBadge}
            <div class="font-medium text-gray-900 dark:text-white">${subjectHTML}</div>
          </div>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            ${teacherHTML}${roomHTML}
          </div>
        </div>
        <div class="mono text-sm text-gray-600 dark:text-gray-400 ml-4">
          ${escapeHTML(p.start)} - ${escapeHTML(p.end)}
        </div>
      </div>
    `;
                    })
                    .join("");

                box.classList.remove("hidden");
                box.innerHTML = header + itemsHTML;
            }

            const getScheduleByWd = (wd) => SCHEDULE[wd] ?? [];

            const enrichPeriods = (periods, baseDate = new Date()) =>
                periods
                    .map((p) => ({
                        ...p,
                        startDate: parseHM(p.start, baseDate),
                        endDate: parseHM(p.end, baseDate),
                    }))
                    .sort((a, b) => a.startDate - b.startDate);

            const findNowPrevNext = (periods, now = new Date()) => {
                const N = periods.length;
                let current = null,
                    prev = null,
                    next = null;
                for (let i = 0; i < N; i++) {
                    const p = periods[i];
                    if (now >= p.startDate && now < p.endDate) {
                        current = p;
                        prev = periods[i - 1] ?? null;
                        let nextIndex = i + 1;
                        while (
                            nextIndex < N &&
                            periods[nextIndex].code &&
                            current.code &&
                            periods[nextIndex].code === current.code
                        )
                            nextIndex++;
                        next = periods[nextIndex] ?? null;
                        break;
                    }
                }
                if (!current) {
                    prev =
                        periods.filter((p) => p.endDate <= now).slice(-1)[0] ??
                        null;
                    const firstUpcomingIndex = periods.findIndex(
                        (p) => p.startDate > now
                    );
                    if (firstUpcomingIndex !== -1) {
                        let nextIndex = firstUpcomingIndex;
                        if (prev && periods[nextIndex].code === prev.code) {
                            let j = nextIndex;
                            while (j < N && periods[j].code === prev.code) j++;
                            nextIndex = j;
                        }
                        next = periods[nextIndex] ?? null;
                    } else {
                        next = null;
                    }
                }
                return { current, prev, next };
            };

            const el = (id) => document.getElementById(id);

            function renderTodayTable(periods, now = new Date()) {
                const wrap = el("todayTable");
                wrap.innerHTML = "";
                if (!periods.length) {
                    wrap.innerHTML = `<div class="p-6 text-center text-gray-400 dark:text-gray-600 bg-white dark:bg-gray-900 rounded-2xl border border-dashed border-gray-300 dark:border-gray-800">วันนี้ไม่มีตารางเรียน</div>`;
                    return;
                }

                periods.forEach((p) => {
                    const active = now >= p.startDate && now < p.endDate;
                    const isBreak = p.code === "BREAK";
                    const matched = isMatch(p, searchTerm);

                    const bgClass = active
                        ? "bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800"
                        : "bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-800";

                    const fadeClass =
                        !matched && searchTerm ? "opacity-50" : "";

                    const subjectHTML = isBreak
                        ? escapeHTML(p.subject)
                        : highlightHTML(p.subject, searchTerm);

                    const teacherText = p.teacher ? `ครู${p.teacher}` : "";
                    const teacherHTML = highlightHTML(teacherText, searchTerm);

                    const roomText =
                        p.room && !isBreak ? ` • ห้อง ${p.room}` : "";
                    const roomHTML = escapeHTML(roomText);

                    wrap.insertAdjacentHTML(
                        "beforeend",
                        isBreak
                            ? `
      <div class="p-4 rounded-xl border ${bgClass} ${fadeClass} flex items-center justify-center text-center">
        <div>
          <div class="font-medium text-gray-900 dark:text-white">
            ${subjectHTML}
          </div>
          <div class="mono text-sm text-gray-600 dark:text-gray-400 mt-1">
            ${fmtHM(p.startDate)} - ${fmtHM(p.endDate)}
          </div>
        </div>
      </div>
    `
                            : `
      <div class="p-4 rounded-xl border ${bgClass} ${fadeClass} flex items-center justify-between">
        <div class="flex-1">
          <div class="font-medium text-gray-900 dark:text-white">
            ${subjectHTML}
          </div>
          <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
            ${teacherHTML}${roomHTML}
          </div>
        </div>
        <div class="mono text-sm text-gray-600 dark:text-gray-400 ml-4">
          ${fmtHM(p.startDate)} - ${fmtHM(p.endDate)}
        </div>
      </div>
    `
                    );
                });
            }

            el("prevDayBtn").onclick = () => {
                if (selectedWd > 1) {
                    selectedWd--;
                    render(new Date());
                }
            };

            el("nextDayBtn").onclick = () => {
                if (selectedWd < 5) {
                    selectedWd++;
                    render(new Date());
                }
            };

            function updateDayButtons() {
                const prevBtn = el("prevDayBtn");
                const nextBtn = el("nextDayBtn");

                prevBtn.disabled = selectedWd <= 1;
                nextBtn.disabled = selectedWd >= 5;

                // เพิ่มคลาสแสดงสถานะ disabled ดูสวยขึ้น
                [prevBtn, nextBtn].forEach((btn) => {
                    if (btn.disabled) {
                        btn.classList.add("opacity-50", "cursor-not-allowed");
                    } else {
                        btn.classList.remove(
                            "opacity-50",
                            "cursor-not-allowed"
                        );
                    }
                });
            }

            function renderWeekdayTabs() {
                const tabs = el("weekdayTabs");
                tabs.innerHTML = "";

                for (let wd = 1; wd <= 5; wd++) {
                    const label = WEEKDAY_THAI[wd];
                    const isActive = wd === selectedWd;

                    const btn = document.createElement("button");
                    btn.className =
                        "tab-btn px-3 py-2 rounded-xl border text-sm dark:border-gray-800 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800";
                    btn.setAttribute("aria-current", String(isActive));
                    btn.innerHTML = `<span class="tab-label">${label}</span>`;
                    btn.addEventListener("click", () => {
                        selectedWd = wd;
                        render(new Date());
                    });

                    tabs.appendChild(btn);
                }
                updateDayButtons();
            }

            function toggleLiveBlocks(show) {
                el("currentBlock").style.display = show ? "" : "none";
                el("adjacentBlock").style.display = show ? "" : "none";
            }

            function render(now = new Date()) {
                // นาฬิกาและวันที่จริง
                el("nowTime").textContent = now.toLocaleTimeString("th-TH", {
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                });
                el("nowDate").textContent =
                    `${WEEKDAY_THAI[now.getDay()]}ที่ ` +
                    now.toLocaleDateString("th-TH", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                    });

                // สร้างแท็บวัน (อัปเดตสถานะ active)
                renderWeekdayTabs();
                renderSearchResults(searchTerm);

                // ชื่อหัวเรื่องของตาราง
                const isTodaySelected = selectedWd === now.getDay();
                el("todayTitle").textContent = isTodaySelected
                    ? "ตารางวันนี้"
                    : `ตารางวัน${WEEKDAY_THAI[selectedWd]}`;

                // เลือกชุดข้อมูลตามวัน
                const baseDate = new Date(now); // สำหรับคำนวณเวลาเริ่ม-จบ
                const todayRaw = getScheduleByWd(selectedWd);
                const today = enrichPeriods(todayRaw, baseDate);

                // ตารางรายวิชา
                renderTodayTable(
                    today,
                    isTodaySelected
                        ? now
                        : new Date(baseDate.setHours(0, 0, 0, 0))
                );

                // แสดง/ซ่อนบล็อกคาบปัจจุบัน-ก่อนหน้า-ถัดไป
                toggleLiveBlocks(isTodaySelected);

                if (isTodaySelected) {
                    const { current, prev, next } = findNowPrevNext(today, now);

                    // Current period
                    const currentCard = el("currentCard");
                    if (current) {
                        const isBreak = current.code === "BREAK";
                        currentCard.className = isBreak
                            ? "p-8 bg-gradient-to-br from-gray-400 to-gray-500 dark:from-gray-700 dark:to-gray-800 rounded-2xl shadow-lg text-white"
                            : "p-8 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-2xl shadow-lg text-white";

                        el("currentSubject").textContent = current.subject;
                        el("currentTeacher").textContent = current.teacher
                            ? `ครู${current.teacher}${
                                  current.room ? ` • ห้อง ${current.room}` : ""
                              }`
                            : current.room
                            ? `ห้อง ${current.room}`
                            : "";
                        el("currentTime").textContent = `${fmtHM(
                            current.startDate
                        )} - ${fmtHM(current.endDate)}`;
                        const left = current.endDate - now;
                        el(
                            "currentStatus"
                        ).textContent = `เหลือเวลาอีก ${humanizeMs(left)}`;
                    } else {
                        currentCard.className =
                            "p-8 bg-gradient-to-br from-gray-400 to-gray-500 dark:from-gray-800 dark:to-gray-900 rounded-2xl shadow-lg text-white";
                        el("currentSubject").textContent = "ไม่มีคาบในขณะนี้";
                        el("currentTeacher").textContent = "—";
                        el("currentTime").textContent = "—";
                        el("currentStatus").textContent = "พักผ่อน";
                    }

                    // Previous
                    if (prev) {
                        el("prevSubject").textContent = prev.subject;
                        el("prevTeacher").textContent = prev.teacher
                            ? `ครู${prev.teacher}`
                            : "";
                        el("prevTime").textContent = `${fmtHM(
                            prev.startDate
                        )} - ${fmtHM(prev.endDate)}`;
                        el("prevEnded").textContent = `จบไปแล้ว ${humanizeMs(
                            now - prev.endDate
                        )}`;
                    } else {
                        el("prevSubject").textContent = "—";
                        el("prevTeacher").textContent = "—";
                        el("prevTime").textContent = "—";
                        el("prevEnded").textContent = "—";
                    }

                    // Next
                    if (next) {
                        el("nextSubject").textContent = next.subject;
                        el("nextTeacher").textContent = next.teacher
                            ? `ครู${next.teacher}`
                            : "";
                        el("nextTime").textContent = `${fmtHM(
                            next.startDate
                        )} - ${fmtHM(next.endDate)}`;
                        const msUntil = Math.max(0, next.startDate - now);
                        el(
                            "nextCountdown"
                        ).textContent = `เริ่มในอีก ${humanizeMs(msUntil)}`;
                    } else {
                        el("nextSubject").textContent = "—";
                        el("nextTeacher").textContent = "—";
                        el("nextTime").textContent = "—";
                        el("nextCountdown").textContent = "—";
                    }
                }
            }

            function initSchedule() {
                render(new Date());
                setInterval(() => render(new Date()), 1000);
            }
            // ---------- Wire search input ----------
            const searchInput = () => document.getElementById("searchInput");
            const clearSearchBtn = () =>
                document.getElementById("clearSearchBtn");

            const applySearch = debounce(() => {
                searchTerm = (searchInput()?.value || "").trim();
                render(new Date());
            }, 120);

            window.addEventListener("DOMContentLoaded", () => {
                const inp = searchInput();
                const clr = clearSearchBtn();
                if (inp) {
                    inp.addEventListener("input", applySearch);
                }
                if (clr) {
                    clr.addEventListener("click", () => {
                        if (!inp) return;
                        inp.value = "";
                        searchTerm = "";
                        render(new Date());
                        inp.focus();
                    });
                }
                window.addEventListener("keydown", (e) => {
                    if (
                        e.key === "/" &&
                        !e.metaKey &&
                        !e.ctrlKey &&
                        !e.altKey
                    ) {
                        const tag = (
                            document.activeElement?.tagName || ""
                        ).toLowerCase();
                        if (tag !== "input" && tag !== "textarea") {
                            e.preventDefault();
                            inp?.focus();
                            inp?.select();
                        }
                    }
                });
            });

            loadSchedule();
        </script>
    </body>
</html>
